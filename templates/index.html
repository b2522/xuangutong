<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>热点题材解读</title>
    <!-- 引入ECharts库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2.5em;
            font-weight: 600;
        }
        
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .search-container {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        
        .search-container input {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .search-container input:focus {
            outline: none;
            border-color: #2c3e50;
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1), 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        #dateFilter {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        
        #dateFilter:focus {
            outline: none;
            border-color: #2c3e50;
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1), 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            margin-top: 5px;
        }
        
        .search-suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 5px;
            margin: 2px 10px;
        }
        
        .search-suggestion-item:hover {
            background-color: #f0f4f8;
            transform: translateX(5px);
        }
        
        button {
            background-color: #0066CC;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            background-color: #004080;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            padding: 18px 15px;
            text-align: center;
            border-bottom: 3px solid #4285F4;
            background-color: #4285F4;
            color: white;
            font-weight: 600;
            font-size: inherit;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 15px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
            transition: all 0.2s ease;
        }
        
        tr {
            transition: all 0.3s ease;
        }
        
        tr:nth-child(even) {
            background-color: #fafbff;
        }
        
        tr:hover {
            background-color: #f0f4f8;
        }
        
        tr:hover td {
            background-color: transparent;
        }
        
        td:nth-child(1), td:nth-child(2), td:nth-child(5), td:nth-child(6), td:nth-child(7), td:nth-child(9), td:nth-child(10) {
            text-align: center;
        }
        
        /* 调整列宽 */
        th:nth-child(1), td:nth-child(1) {
            width: 120px; /* 第一列：股票名称 */
        }
        
        th:nth-child(2), td:nth-child(2) {
            width: 120px; /* 第二列：分时图 */
            text-align: center;
            padding: 0;
        }
        
        th:nth-child(3), td:nth-child(3) {
            width: 80px; /* 第三列：价格 */
            text-align: right;
        }
        
        th:nth-child(4), td:nth-child(4) {
            width: 80px; /* 第四列：涨跌幅 */
            text-align: right;
        }
        
        /* 分时图容器样式 */
        .time-chart {
            width: 120px;
            height: 60px;
            margin: 0 auto;
            display: block;
        }
        
        /* 确保分时图列的单元格有足够的高度 */
        td:nth-child(2) {
            height: 60px;
            padding: 0;
        }
        
        /* 隐藏代码列和市场列 */
        th:nth-child(5), td:nth-child(5), /* 第五列：代码 */
        th:nth-child(6), td:nth-child(6)  /* 第六列：市场 */
        {
            display: none;
        }
        
        th:nth-child(7), td:nth-child(7) {
            width: 100px; /* 第七列：几天几板 */
        }
        
        th:nth-child(8), td:nth-child(8) {
            width: 500px; /* 第八列：解读 - 增加宽度以完整显示内容 */
        }
        
        th:nth-child(9), td:nth-child(9) {
            width: 100px; /* 第九列：所属题材 - 适当减少宽度 */
        }
        
        th:nth-child(10), td:nth-child(10) {
            width: 100px; /* 第十列：日期 - 适当减少宽度 */
        }
        
        /* 排序表头样式 */
        th.sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        /* 确保表头没有任何悬停效果 */
        th:hover {
            background-color: #4285F4;
            color: white;
        }
        
        th.sortable::after {
            content: '▼';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
        }
        
        th.sortable.sorted::after {
            color: white;
            transform: translateY(-50%) rotate(180deg);
        }
        
        /* 高级视觉效果 */
        .table-container {
            position: relative;
            overflow-x: auto;
        }
        
        .table-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            z-index: 1;
        }
        
        /* 3开头股票代码显示为橙色 */
        .orange-code {
            color: #FF7F00;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .no-data {
            text-align: center;
            padding: 80px;
            color: #777;
            font-size: 18px;
        }
        
        .date-info {
            background-color: #e8f4f8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }


        

        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                max-width: 100%;
            }
            
            h1 {
                font-size: 2em;
            }
        }
        

    </style>
</head>
<body>
    <div class="container">

        

        
        <!-- 移除重复的搜索框 -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="120px">
                            <div style="display: flex; width: 100%; margin-top: 5px;">
                                <input 
                                    type="text" 
                                    id="searchInput" 
                                    placeholder="股票名称" 
                                    style="padding: 5px; font-size: 14px; width: 100%;"
                                >
                            </div>
                        </th>
                        <th>分时图</th>
                        <th>价格</th>
                        <th class="sortable" onclick="sortByChangePercentage()">涨跌幅</th>
                        <th>代码</th>
                        <th>市场</th>
                        <th class="sortable" onclick="sortByDaysBoards()">几天几板</th>
                        <th>解读</th>
                        <th>
                            <input type="text" id="plateFilter" placeholder="搜索题材" oninput="filterByPlate(this.value)" style="margin: 0 auto; display: block; padding: 5px; border: none; border-radius: 5px;">
                        </th>
                        <th>
                            <input type="date" id="dateFilter" placeholder="选择日期" onchange="filterByDate(this.value)" style="margin: 0 auto; display: block; padding: 5px; border: none; border-radius: 5px;">
                        </th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                    {% if stocks %}
                        {% for stock in stocks %}
                            <tr>
                                <td><a href="https://xuangutong.com.cn/stock/{{ stock.code_part }}.{{ stock.market|upper }}" target="_blank" style="text-decoration: none; color: #2c3e50;">{{ stock.name }}</a></td>
                                <td><div class="time-chart" data-code="{{ stock.code_part }}"></div></td>
                                <td class="price"></td>
                                <td class="change-percentage"></td>
                                <td class="{% if stock.code_part.startswith('3') %}orange-code{% endif %}">{{ stock.code_part }}</td>
                                <td>{{ stock.market }}</td>
                                <td>{{ stock.m_days_n_boards }}</td>
                                <td>{{ stock.description }}</td>
                                <td>{{ stock.plates }}</td>
                                <td>{{ stock.date }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="no-data">暂无股票数据，请点击"抓取股票数据"按钮获取数据</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // 搜索建议功能，从后端API获取数据
        function showSuggestions(inputValue) {
            var suggestionsContainer = document.getElementById('searchSuggestions');
            
            if (inputValue === '') {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            // 发送AJAX请求到后端API
            fetch('/search?keyword=' + encodeURIComponent(inputValue))
                .then(function(response) { return response.json(); })
                .then(function(filteredNames) {
                    console.log('后端返回的搜索结果数量:', filteredNames.length);
                    console.log('搜索结果:', filteredNames);
                    
                    if (filteredNames.length === 0) {
                        suggestionsContainer.style.display = 'none';
                        return;
                    }
                    
                    suggestionsContainer.innerHTML = '';
                    Array.prototype.forEach.call(filteredNames, function(name) {
                        var div = document.createElement('div');
                        div.className = 'search-suggestion-item';
                        div.textContent = name;
                        div.onclick = function() {
                            document.getElementById('searchInput').value = name;
                            suggestionsContainer.style.display = 'none';
                            // 跳转到搜索结果页面
                            window.location.href = '/search-results?keyword=' + encodeURIComponent(name);
                        };
                        suggestionsContainer.appendChild(div);
                    });
                    
                    suggestionsContainer.style.display = 'block';
                })
                .catch(function(error) {
                    console.error('获取搜索建议失败:', error);
                    suggestionsContainer.style.display = 'none';
                });
        }
        
        // 日期过滤功能
        function filterByDate(dateValue) {
            if (!dateValue) {
                // 如果没有选择日期，重新加载页面显示最新数据
                window.location.href = '/';
                return;
            }
            
            // 统一日期格式：将YYYY-MM-DD转换为YYYYMMDD
            var normalizedDate = dateValue.replace(/-/g, '');
            
            // 发送AJAX请求获取指定日期的数据
            fetch('/get-data-by-date?date=' + encodeURIComponent(normalizedDate))
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    var tbody = document.getElementById('stockTableBody');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="no-data">该日期暂无数据</td></tr>';
                        return;
                    }
                    
                    // 渲染数据
                    Array.prototype.forEach.call(data, function(stock) {
                            var row = document.createElement('tr');
                            var link = 'https://xuangutong.com.cn/stock/' + stock.code_part + '.' + stock.market.toUpperCase();
                            var codeClass = stock.code_part.startsWith('3') ? 'orange-code' : '';
                            row.innerHTML = 
                                '<td><a href="' + link + '" target="_blank" style="text-decoration: none; color: #2c3e50;">' + stock.name + '</a></td>' +
                                '<td><div class="time-chart" data-code="' + stock.code_part + '"></div></td>' +
                                '<td class="price"></td>' +
                                '<td class="change-percentage"></td>' +
                                '<td class="' + codeClass + '">' + stock.code_part + '</td>' +
                                '<td>' + stock.market + '</td>' +
                                '<td>' + stock.m_days_n_boards + '</td>' +
                                '<td>' + stock.description + '</td>' +
                                '<td>' + stock.plates + '</td>' +
                                '<td>' + stock.date + '</td>';
                            tbody.appendChild(row);
                        });
                    
                    // 渲染完历史数据后，重置分时图状态并重新渲染
                    visibleStockCodes = {}; // 重置可见股票代码集合
            timeChartInstances = {}; // 重置图表实例
                    setTimeout(function() {
                        renderVisibleCharts(); // 重新渲染可见区域内的分时图
                        fetchRealTimeStockData(); // 获取实时股票数据
                    }, 100);
                })
                .catch(function(error) {
                    console.error('获取指定日期数据失败:', error);
                });
        }
        
        // 重置过滤条件
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('searchSuggestions').style.display = 'none';
            // 重新加载页面显示最新数据
            window.location.href = '/';
        }
        
        // 搜索输入框回车事件
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                var searchTerm = this.value.trim();
                if (searchTerm) {
                    window.location.href = '/search-results?keyword=' + encodeURIComponent(searchTerm);
                }
            }
        });
        
        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchSuggestions').style.display = 'none';
            // 显示所有行
            var rows = document.querySelectorAll('#stockTableBody tr');
            rows.forEach(function(row) {
                row.style.display = '';
            });
        }
        
        // 点击页面其他地方关闭搜索提示
        document.addEventListener('click', function(e) {
            var searchContainer = document.querySelector('.search-container');
            if (!searchContainer.contains(e.target)) {
                document.getElementById('searchSuggestions').style.display = 'none';
            }
        });
        


        // 控制定时刷新的函数
        function controlRefreshTimer() {
            // 清除之前的定时器
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
            
            // 检查是否在交易时间内
            if (isInTradingHours()) {
                // 在交易时间内，启动定时刷新
                console.log('当前处于交易时间，启动定时刷新');
                // 立即执行一次刷新
                fetchRealTimeStockData();
                // 设置定时器，每60秒执行一次
                refreshTimer = setInterval(function() {
                    if (isInTradingHours()) {
                        fetchRealTimeStockData();
                    } else {
                        // 如果不在交易时间内，停止定时器
                        console.log('当前已超出交易时间，停止定时刷新');
                        clearInterval(refreshTimer);
                        refreshTimer = null;
                    }
                }, REFRESH_INTERVAL);
            } else {
                console.log('当前不在交易时间内，不启动定时刷新');
            }
        }
        
        // 节流函数，限制函数调用频率
        function throttle(func, delay) {
            var lastCall = 0;
            return function() {
                var now = Date.now();
                if (now - lastCall >= delay) {
                    lastCall = now;
                    return func.apply(this, arguments);
                }
            };
        }

        // 防抖函数，确保函数只在停止触发一段时间后才执行
        function debounce(func, delay) {
            var timeoutId;
            return function() {
                var context = this;
                var args = arguments;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(function() {
                    func.apply(context, args);
                }, delay);
            };
        }

        // 全局初始化 - 合并所有DOMContentLoaded事件处理逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 处理日期选择器和可用日期加载
            var dateInput = document.getElementById('dateFilter');
            if (dateInput) {
                // 设置最小和最大日期
                var minDate = '2025-12-01';
                var today = new Date().toISOString().split('T')[0];
                dateInput.min = minDate;
                dateInput.max = today;

                // 加载可用日期
                fetch('/available-dates')
                    .then(function(response) { return response.json(); })
                    .then(function(dates) {
                        // 存储可用日期
                        window.availableDates = dates;

                        // 验证选择的日期是否有数据且不是周末
                        dateInput.addEventListener('input', debounce(function(e) {
                            if (this.value) {
                                var selectedDate = this.value.replace(/-/g, '');
                                var dateObj = new Date(this.value);
                                var dayOfWeek = dateObj.getDay(); // 0=周日, 1=周一, ..., 6=周六
                                
                                // 检查是否是周末
                                if (dayOfWeek === 0 || dayOfWeek === 6) {
                                    console.log('选择了周末日期:', selectedDate);
                                    alert('周六、周日不可选择');
                                    this.value = '';
                                    return;
                                }
                                
                                // 直接调用API检查日期是否有数据，而仅依赖缓存列表
                                console.log('检查日期是否有数据:', selectedDate);
                                fetch('/get-data-by-date?date=' + encodeURIComponent(selectedDate))
                                    .then(function(response) {
                                        return response.json();
                                    })
                                    .then(function(data) {
                                        // 如果返回的数据为空数组，说明该日期没有数据
                                        if (!data || data.length === 0) {
                                            console.log('日期无数据:', selectedDate, data);
                                            alert('该日期无数据');
                                            e.target.value = '';
                                        } else {
                                            console.log('日期有数据:', selectedDate, '数据条数:', data.length);
                                        }
                                    })
                                    .catch(function(error) {
                                        console.error('检查日期数据失败:', error);
                                    });
                            }
                        }, 300));
                    })
                    .catch(function(error) {
                        console.error('获取可用日期失败:', error);
                    });
            }
            
            // 分时图初始化
            // 初始渲染可视区域内的图表
            renderVisibleCharts();
            
            // 添加节流处理的滚动事件监听
            window.addEventListener('scroll', throttle(function() {
                renderVisibleCharts();
            }, 100));
            
            // 添加节流处理的窗口大小变化监听
            window.addEventListener('resize', throttle(function() {
                renderVisibleCharts();
            }, 100));
            
            // 启动定时刷新控制
            controlRefreshTimer();
            
            // 启动分时图定时刷新控制
            controlTimeChartRefreshTimer();
            
            // 每5分钟检查一次交易时间状态，确保在交易时间开始时自动启动刷新
            setInterval(controlRefreshTimer, 5 * 60 * 1000);
            setInterval(controlTimeChartRefreshTimer, 5 * 60 * 1000);
            
            // 页面加载完成后自动获取和显示实时股票数据
            fetchRealTimeStockData();
        });
        // 刷新状态控制变量
        var refreshTimer = null;
        var isRefreshing = false;
        var retryCount = 0;
        var MAX_RETRIES = 3;
        var REFRESH_INTERVAL = 60000; // 60秒
        
        // 分时图相关变量
        var timeChartInstances = {}; // 存储图表实例，使用对象替代Map
        var visibleStockCodes = {}; // 存储可见的股票代码，使用对象替代Set
        
        // 数据缓存对象
        var dataCache = {
            timeSharingData: {},
            realTimeData: {},
            cacheDuration: 30000 // 缓存30秒
        };
        
        // 根据股票代码获取分时数据的API调用函数，暂时禁用缓存以解决数据显示问题
        function fetchTimeSharingData(stockCode) {
            // 直接获取最新数据，不使用缓存
            // 使用后端代理来避免CORS问题
            var proxyUrl = '/api/time-sharing-data?code=' + encodeURIComponent(stockCode);
            
            // 返回Promise对象
            return fetch(proxyUrl)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    // 解析JSON响应
                    return response.json();
                })
                .catch(function(error) {
                    console.error(`获取股票 ${stockCode} 的分时数据失败:`, error);
                    return null;
                });
        }
        
        // 根据股票代码生成secid参数
        function generateSecid(stockCode) {
            if (!stockCode || !stockCode.length) {
                return null;
            }
            
            // 根据股票代码前缀确定市场
            var prefix = stockCode[0];
            var market;
            
            if (prefix === '6') {
                market = '1'; // 沪市
            } else if (prefix === '0' || prefix === '3') {
                market = '0'; // 深市
            } else {
                console.error(`不支持的股票代码前缀: ${prefix}`);
                return null;
            }
            
            // 格式为：market.stockCode
            return market + '.' + stockCode;
        }
        
        // 解析分时数据的函数
        function parseTimeSharingData(data) {
            if (!data || data.rc !== 0 || !data.data) {
                return null;
            }
            
            var preClose = data.data.preClose;
            var trends = data.data.trends;
            
            if (!preClose || !Array.isArray(trends)) {
                return null;
            }
            
            // 解析trends数组
            var parsedData = {
                preClose: parseFloat(preClose),
                dataPoints: []
            };
            
            trends.forEach(function(trendItem) {
                var parts = trendItem.split(',');
                var time = parts[0];
                var price = parts[1];
                if (time && price) {
                    // 使用更兼容的方式解析日期时间
                    // 假设time格式为："2024-10-15 09:30:00"
                    var dateTime = parseDateTime(time);
                    parsedData.dataPoints.push({
                        time: dateTime,
                        price: parseFloat(price)
                    });
                    
                    // 调试：检查13:00-13:01的数据点
                    if (time.includes('13:00') || time.includes('13:01')) {
                        console.log('原始数据中的13:00-13:01数据点:', time, '价格:', price);
                    }
                }
            });
            
            console.log('过滤前的数据点数量:', parsedData.dataPoints.length);
            
            // 过滤数据，排除11:31~12:59的时间段
            parsedData.dataPoints = parsedData.dataPoints.filter(function(point) {
                var hours = point.time.getHours();
                var minutes = point.time.getMinutes();
                
                // 明确的过滤条件：排除11:31-12:59之间的所有时间
                var shouldFilter = (hours === 11 && minutes >= 31) || (hours === 12);
                
                // 调试：检查关键时间点
                if ((hours === 11 && minutes >= 29) || (hours === 13 && minutes <= 2)) {
                    console.log('检查关键数据点:', hours + ':' + minutes, '是否被过滤:', shouldFilter);
                }
                
                return !shouldFilter;
            });
            
            console.log('过滤后的数据点数量:', parsedData.dataPoints.length);
            
            // 调试：查看过滤后的13:00-13:02数据点
            var afternoonDataPoints = parsedData.dataPoints.filter(function(point) {
                var hours = point.time.getHours();
                var minutes = point.time.getMinutes();
                return hours === 13 && minutes <= 2;
            });
            console.log('过滤后的13:00-13:02数据点:', afternoonDataPoints);
            
            // 调试：查看过滤后的最后10个数据点
            console.log('过滤后的最后10个数据点:', parsedData.dataPoints.slice(-10));
            
            // 调试：查看过滤后的前10个下午数据点
            var afternoonStartIndex = parsedData.dataPoints.findIndex(function(point) {
                var hours = point.time.getHours();
                return hours >= 13;
            });
            if (afternoonStartIndex !== -1) {
                console.log('下午数据点开始位置:', afternoonStartIndex);
                console.log('前10个下午数据点:', parsedData.dataPoints.slice(afternoonStartIndex, afternoonStartIndex + 10));
            }
            
            return parsedData;
        }
        
        // 兼容不同浏览器的日期时间解析函数
        function parseDateTime(dateTimeString) {
            // 处理常见的日期时间格式
            if (!dateTimeString) {
                return new Date();
            }
            
            // 尝试直接解析（现代浏览器）
            var date = new Date(dateTimeString);
            
            // 如果解析失败，尝试手动解析
            if (isNaN(date.getTime())) {
                // 支持两种格式："YYYY-MM-DD HH:mm:ss" 和 "YYYY-MM-DD HH:mm"
                var parts = dateTimeString.split(/[- :]/);
                if (parts.length === 6) {
                    // 格式：YYYY-MM-DD HH:mm:ss
                    return new Date(
                        parseInt(parts[0]),   // 年
                        parseInt(parts[1])-1, // 月（0-11）
                        parseInt(parts[2]),   // 日
                        parseInt(parts[3]),   // 时
                        parseInt(parts[4]),   // 分
                        parseInt(parts[5])    // 秒
                    );
                } else if (parts.length === 5) {
                    // 格式：YYYY-MM-DD HH:mm
                    return new Date(
                        parseInt(parts[0]),   // 年
                        parseInt(parts[1])-1, // 月（0-11）
                        parseInt(parts[2]),   // 日
                        parseInt(parts[3]),   // 时
                        parseInt(parts[4]),   // 分
                        0                     // 秒
                    );
                }
            }
            
            return date;
        }
        
        // 初始化和绘制分时图的函数
        function initTimeChart(container, stockCode) {
            // 检查容器是否存在
            if (!container) {
                return;
            }
            
            // 创建图表实例，使用canvas渲染器以获得更好的性能
            var chart = echarts.init(container, null, {
                renderer: 'canvas',
                useDirtyRect: true // 使用脏矩形渲染优化
            });
            
            // 存储图表实例
            timeChartInstances[stockCode] = chart;
            
            // 设置图表配置，简化不必要的功能
            var option = {
                grid: {
                    left: 0,
                    right: 0,
                    top: 0,
                    bottom: 0,
                    containLabel: true
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        var data = params[0];
                        // 由于X轴改为category类型，data.name已经是HH:MM格式的字符串
                        var time = data.name;
                        var price = data.value[1].toFixed(2);
                        return time + '<br/>价格: ' + price;
                    },
                    axisPointer: {
                        type: 'line' // 使用更简单的line类型代替cross
                    }
                },
                xAxis: {
                    type: 'category',
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { show: false },
                    splitLine: { show: false },
                    splitNumber: 3 // 减少分割线数量
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { show: false },
                    splitLine: { show: false },
                    splitNumber: 2 // 减少分割线数量
                },
                // 禁用数据缩放以提高性能
                series: [
                    {
                        type: 'line',
                        data: [],
                        smooth: false, // 禁用平滑曲线以提高性能
                        symbol: 'none',
                        lineStyle: {
                            width: 1
                        },
                        areaStyle: {
                            opacity: 0.1
                        },
                        animation: false // 禁用动画以提高性能
                    }
                ]
            };
            
            chart.setOption(option);
            
            // 添加窗口大小变化监听，使用节流处理
            var resizeHandler = throttle(function() {
                chart.resize();
            }, 100);
            
            window.addEventListener('resize', resizeHandler);
            
            // 存储resize处理函数，以便稍后移除
            chart.resizeHandler = resizeHandler;
            
            return chart;
        }
        
        // 根据数据更新图表
        function updateTimeChart(chart, parsedData) {
            if (!chart || !parsedData) {
                return;
            }
            
            var preClose = parsedData.preClose;
            var dataPoints = parsedData.dataPoints;
            
            // 准备图表数据，将时间转换为字符串格式以适应category类型X轴
            var chartData = dataPoints.map(function(point) {
                // 将时间对象转换为HH:MM格式的字符串
                var date = new Date(point.time);
                var hours = date.getHours().toString().padStart(2, '0');
                var minutes = date.getMinutes().toString().padStart(2, '0');
                var timeStr = hours + ':' + minutes;
                return [timeStr, point.price];
            });
            
            // 设置线条颜色
            var lineColor = '#333'; // 默认颜色
            var areaColor = '#333';
            
            if (dataPoints.length > 0) {
                var lastPrice = dataPoints[dataPoints.length - 1].price;
                if (lastPrice > preClose) {
                    lineColor = '#e33232'; // 红色
                    // 使用ECharts兼容的方式定义渐变
                    areaColor = {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(227, 50, 50, 0.5)' },
                            { offset: 1, color: 'rgba(227, 50, 50, 0.1)' }
                        ]
                    };
                } else if (lastPrice < preClose) {
                    lineColor = '#00a854'; // 绿色
                    // 使用ECharts兼容的方式定义渐变
                    areaColor = {
                        type: 'linear',
                        x: 0, y: 0, x2: 0, y2: 1,
                        colorStops: [
                            { offset: 0, color: 'rgba(0, 168, 84, 0.5)' },
                            { offset: 1, color: 'rgba(0, 168, 84, 0.1)' }
                        ]
                    };
                }
            }
            
            // 更新图表配置
            chart.setOption({
                yAxis: {
                    min: function(value) {
                        // 设置Y轴最小值为略低于最低价格
                        return Math.min(value.min, preClose) - (Math.abs(value.max - value.min) * 0.1);
                    },
                    max: function(value) {
                        // 设置Y轴最大值为略高于最高价格
                        return Math.max(value.max, preClose) + (Math.abs(value.max - value.min) * 0.1);
                    }
                },
                series: [
                    {
                        data: chartData,
                        lineStyle: {
                            color: lineColor
                        },
                        areaStyle: {
                            color: areaColor
                        }
                    }
                ]
            });
        }
        
        // 绘制分时图的主函数
        function drawTimeChart(container, stockCode) {
            if (!container || !stockCode) {
                return;
            }
            
            // 确保容器有正确的尺寸
            if (container.offsetWidth === 0 || container.offsetHeight === 0) {
                // 容器尺寸为0，等待下一次渲染
                return;
            }
            
            // 如果已经存在图表实例，直接更新数据
            if (timeChartInstances[stockCode]) {
                fetchTimeSharingData(stockCode)
                    .then(function(rawData) {
                        if (!rawData) {
                            return;
                        }
                        
                        // 解析数据
                        var parsedData = parseTimeSharingData(rawData);
                        if (!parsedData) {
                            return;
                        }
                        
                        // 更新图表
                        updateTimeChart(timeChartInstances[stockCode], parsedData);
                    })
                    .catch(function(error) {
                        console.error('更新股票 ' + stockCode + ' 分时图失败:', error);
                    });
            } else {
                // 获取分时数据
                fetchTimeSharingData(stockCode)
                    .then(function(rawData) {
                        if (!rawData) {
                            return;
                        }
                        
                        // 解析数据
                        var parsedData = parseTimeSharingData(rawData);
                        if (!parsedData) {
                            return;
                        }
                        
                        // 初始化图表
                        var chart = initTimeChart(container, stockCode);
                        if (!chart) {
                            return;
                        }
                        
                        // 更新图表
                        updateTimeChart(chart, parsedData);
                    })
                    .catch(function(error) {
                        console.error('绘制股票 ' + stockCode + ' 分时图失败:', error);
                    });
            }
        }
        
        // 检查元素是否在可视区域内（兼容跨浏览器）
        function isElementInViewport(el) {
            if (!el) {
                return false;
            }
            
            var rect = el.getBoundingClientRect();
            var viewportWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
            var viewportHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
            
            // 检查元素是否完全或部分在视口中
            // 对于分时图，只要部分可见就应该渲染
            return (
                rect.left < viewportWidth &&
                rect.right > 0 &&
                rect.top < viewportHeight &&
                rect.bottom > 0
            );
        }
        
        // 渲染可视区域内的分时图
        function renderVisibleCharts() {
            var chartContainers = document.querySelectorAll('.time-chart');
            
            // 检查是否有任何容器在视口中
            var anyVisible = false;
            Array.prototype.forEach.call(chartContainers, function(container) {
                if (isElementInViewport(container)) {
                    anyVisible = true;
                    return false; // 提前退出循环
                }
            });
            
            // 如果没有任何容器在视口中，直接返回
            if (!anyVisible) {
                return;
            }
            
            Array.prototype.forEach.call(chartContainers, function(container) {
                var stockCode = container.getAttribute('data-code');
                
                if (stockCode && isElementInViewport(container) && !visibleStockCodes[stockCode]) {
                    // 元素在可视区域内且未渲染过
                    visibleStockCodes[stockCode] = true;
                    drawTimeChart(container, stockCode);
                }
            });
        }
        

        
        // 刷新所有已渲染的分时图
        function refreshTimeCharts() {
            if (Object.keys(visibleStockCodes).length === 0) {
                return;
            }
            
            // 获取所有可见的股票代码
            var stockCodes = Object.keys(visibleStockCodes);
            
            // 使用Promise.all并发处理所有请求
            var promises = Array.prototype.map.call(stockCodes, function(stockCode) {
                // 获取最新的分时数据
                return fetchTimeSharingData(stockCode)
                    .then(function(rawData) {
                        if (!rawData) {
                            return;
                        }
                        
                        // 解析数据
                        var parsedData = parseTimeSharingData(rawData);
                        if (!parsedData) {
                            return;
                        }
                        
                        // 获取对应的图表实例
                        var chart = timeChartInstances[stockCode];
                        if (chart) {
                            // 更新图表
                            updateTimeChart(chart, parsedData);
                        }
                    });
            });
            
            // 处理所有Promise完成后的情况
            Promise.all(promises)
                .catch(function(error) {
                    console.error('刷新分时图失败:', error);
                });
        }
        
        // 控制分时图定时刷新的函数
        function controlTimeChartRefreshTimer() {
            // 清除之前的定时器
            if (timeChartRefreshTimer) {
                clearInterval(timeChartRefreshTimer);
                timeChartRefreshTimer = null;
            }
            
            // 检查是否在交易时间内
            if (isInTradingHours()) {
                // 在交易时间内，启动定时刷新
                console.log('当前处于交易时间，启动分时图定时刷新');
                // 设置定时器，每60秒执行一次
                timeChartRefreshTimer = setInterval(function() {
                    if (isInTradingHours()) {
                        refreshTimeCharts();
                    } else {
                        // 如果不在交易时间内，停止定时器
                        console.log('当前已超出交易时间，停止分时图定时刷新');
                        clearInterval(timeChartRefreshTimer);
                        timeChartRefreshTimer = null;
                    }
                }, REFRESH_INTERVAL);
            } else {
                console.log('当前不在交易时间内，不启动分时图定时刷新');
            }
        }
        
        // 分时图刷新状态控制变量
        var timeChartRefreshTimer = null;
        
        // 显示刷新状态

        
        // 检查当前时间是否在交易时间段内（周一到周五 9:25-15:00）
        function isInTradingHours() {
            var now = new Date();
            var day = now.getDay(); // 0-6，0=周日，1-5=周一到周五
            var hours = now.getHours();
            var minutes = now.getMinutes();
            
            // 判断是否为周一到周五
            if (day < 1 || day > 5) {
                return false;
            }
            
            // 判断是否在9:25-15:00之间
            if (hours < 9 || hours > 14) {
                return false;
            }
            
            if (hours === 9 && minutes < 25) {
                return false;
            }
            
            return true;
        }
        
        // 获取实时股票数据
        function fetchRealTimeStockData() {
            // 如果正在刷新中，直接返回
            if (isRefreshing) {
                return;
            }
            
            var tbody = document.getElementById('stockTableBody');
            // 使用更兼容的方式选择行
            var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr')).filter(function(row) {
                return !row.querySelector('td[colspan]');
            });
            
            if (rows.length === 0) {
                return;
            }
            
            isRefreshing = true;
            retryCount = 0;
            
            // 收集所有股票代码并格式化
            var stockCodes = [];
            var codeMap = {}; // 用于存储股票代码和对应的行，使用普通对象替代Map
            var stockCodeSet = {}; // 用于去重股票代码，使用普通对象替代Set
            var codesToFetch = []; // 需要从API获取的股票代码
            
            Array.prototype.forEach.call(rows, function(row) {
                var codeElement = row.querySelector('td:nth-child(5)'); // 代码列现在是第5列
                var dateElement = row.querySelector('td:nth-child(10)'); // 日期列现在是第10列
                if (codeElement && dateElement) {
                    var code = codeElement.textContent.trim();
                    var date = dateElement.textContent.trim();
                    if (code && date) {
                        // 根据代码判断市场
                        var market = '';
                        if (code.startsWith('6')) {
                            market = 'SH';
                        } else if (code.startsWith('0') || code.startsWith('3')) {
                            market = 'SZ';
                        }
                        
                        if (market) {
                            var formattedCode = market + code;
                            // 只添加不重复的股票代码到API请求列表
                            if (!stockCodeSet[formattedCode]) {
                                stockCodeSet[formattedCode] = true;
                                stockCodes.push(formattedCode);
                                
                                // 检查缓存
                                var cached = dataCache.realTimeData[formattedCode];
                                if (!cached || Date.now() - cached.timestamp >= dataCache.cacheDuration) {
                                    codesToFetch.push(formattedCode);
                                }
                            }
                            // 使用股票代码和日期的组合作为键，确保唯一性
                            var uniqueKey = code + '_' + date;
                            codeMap[uniqueKey] = row;
                        }
                    }
                }
            });
            
            if (stockCodes.length === 0) {
                return;
            }
            
            // 合并缓存数据和需要从API获取的数据
            var allData = {};
            
            // 先添加所有缓存数据
            stockCodes.forEach(function(code) {
                var cached = dataCache.realTimeData[code];
                if (cached && Date.now() - cached.timestamp < dataCache.cacheDuration) {
                    allData[code] = cached.data;
                }
            });
            
            // 如果没有需要从API获取的数据，直接使用缓存数据更新
            if (codesToFetch.length === 0) {
                updateStockTable(allData, rows, codeMap);
                isRefreshing = false;
                return;
            }
            
            // 构建API URL（使用后端代理）
            var apiUrl = '/api/realtime-stock-data?symbols=' + codesToFetch.join(',') + '&_=' + Date.now();
            
            // 发送API请求获取实时数据
            fetch(apiUrl)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(function(data) {
                    // 检查返回数据是否有效
                    if (data && data.data) {
                        // 更新缓存并合并数据
                        Array.prototype.forEach.call(data.data, function(stock) {
                            allData[stock.symbol] = stock;
                            // 更新缓存
                            dataCache.realTimeData[stock.symbol] = {
                                data: stock,
                                timestamp: Date.now()
                            };
                        });
                        
                        // 使用合并后的数据更新表格
                        updateStockTable(allData, rows, codeMap);
                        retryCount = 0;
                    } else {
                        throw new Error('无效的返回数据');
                    }
                })
                .catch(function(error) {
                    console.error('获取实时股票数据失败:', error);
                    // 如果API请求失败，尝试使用缓存数据
                    if (Object.keys(allData).length > 0) {
                        updateStockTable(allData, rows, codeMap);
                    }
                    
                    retryCount++;
                    
                    if (retryCount < MAX_RETRIES) {
                        // 重试
                        setTimeout(function() {
                            fetchRealTimeStockData();
                        }, 3000); // 3秒后重试
                    } else {
                        // 达到最大重试次数
                        retryCount = 0;
                    }
                })
                .finally(function() {
                    // 刷新完成
                    isRefreshing = false;
                });
        }
        
        // 更新股票表格数据的辅助函数
        function updateStockTable(data, rows, codeMap) {
            if (!data || Object.keys(data).length === 0) {
                return;
            }
            
            // 遍历所有股票数据
            Object.keys(data).forEach(function(symbol) {
                var stock = data[symbol];
                var code = stock.symbol.substring(2); // 获取6位股票代码
                
                // 查找所有包含该股票代码的行
                Array.prototype.forEach.call(rows, function(row) {
                    var rowCodeElement = row.querySelector('td:nth-child(5)');
                    var rowDateElement = row.querySelector('td:nth-child(10)');
                    if (rowCodeElement && rowDateElement) {
                        var rowCode = rowCodeElement.textContent.trim();
                        var rowDate = rowDateElement.textContent.trim();
                        if (rowCode === code && rowDate) {
                            var uniqueKey = rowCode + '_' + rowDate;
                            var targetRow = codeMap[uniqueKey];
                            
                            if (targetRow) {
                                // 确定颜色（红色上涨，绿色下跌，黑色不变）
                                var color = stock.percent > 0 ? '#e33232' : (stock.percent < 0 ? '#00a854' : '');
                                
                                // 更新价格
                                var priceElement = targetRow.querySelector('.price');
                                if (priceElement) {
                                    priceElement.textContent = stock.current || '-';
                                    priceElement.style.color = color;
                                }
                                
                                // 更新涨跌幅
                                var changeElement = targetRow.querySelector('.change-percentage');
                                if (changeElement) {
                                    changeElement.textContent = (stock.percent || 0).toFixed(2) + '%';
                                    changeElement.style.color = color;
                                }
                            }
                        }
                    }
                });
            });
        }
        
        // 第六列【几天几板】降序排列功能
        var isSortedDesc = false;
        var isChangeSortedDesc = false;
        
        function sortByDaysBoards() {
            var tbody = document.getElementById('stockTableBody');
            var rows = Array.prototype.slice.call(tbody.getElementsByTagName('tr')).filter(function(row) {
                return !row.querySelector('td[colspan]');
            });
            var header = document.querySelector('th.sortable:nth-child(7)');
            
            // 解析几天几板中的数字
            function getBoardCount(text) {
                if (!text) return 0;
                // 匹配天数和板数，例如 "3天3板" 会匹配到两个数字 [3, 3]
                var matches = text.match(/\d+/g);
                if (matches) {
                    // 优先使用板数（第二个数字），如果没有则使用天数（第一个数字）
                    return parseInt(matches[matches.length - 1]);
                }
                return 0;
            }
            
            // 排序
            rows.sort(function(a, b) {
                var aCount = getBoardCount(a.cells[6].textContent);
                var bCount = getBoardCount(b.cells[6].textContent);
                
                if (isSortedDesc) {
                    return aCount - bCount; // 升序
                } else {
                    return bCount - aCount; // 降序
                }
            });
            
            // 重新添加行
            Array.prototype.forEach.call(rows, function(row) {
                tbody.appendChild(row);
            });
            
            // 更新排序状态
            isSortedDesc = !isSortedDesc;
            
            // 更新表头样式
            header.classList.toggle('sorted', !isSortedDesc);
        }

        function sortByChangePercentage() {
            console.log('开始涨跌幅排序...');
            var tbody = document.getElementById('stockTableBody');
            var rows = Array.prototype.slice.call(tbody.getElementsByTagName('tr')).filter(function(row) {
                return !row.querySelector('td[colspan]');
            });
            var header = document.querySelector('th.sortable:nth-child(4)');
            
            // 解析涨跌幅百分比数值
            function getChangePercentage(element) {
                if (!element) {
                    console.log('元素不存在');
                    return 0;
                }
                // 直接从td元素获取文本（td本身就有change-percentage类）
                var text = element.textContent || '';
                console.log('涨跌幅文本:', text);
                if (!text) return 0;
                // 移除%符号并转换为数字
                var matches = text.match(/[-+]?\d+(?:\.\d+)?/);
                if (matches) {
                    var value = parseFloat(matches[0]);
                    console.log('解析的数值:', value);
                    return value;
                }
                console.log('未找到匹配的数值');
                return 0;
            }
            
            // 排序前记录一些数据
            console.log('排序前的前5行数据:');
            for (var i = 0; i < Math.min(5, rows.length); i++) {
                var cell = rows[i].cells[3];
                var text = cell.textContent || '';
                console.log('行' + (i+1) + ': ' + text);
            }
            
            // 排序
            rows.sort(function(a, b) {
                var aChange = getChangePercentage(a.cells[3]); // 涨跌幅是第4列，索引为3
                var bChange = getChangePercentage(b.cells[3]);
                
                console.log('比较:', aChange, 'vs', bChange);
                
                if (isChangeSortedDesc) {
                    return aChange - bChange; // 升序
                } else {
                    return bChange - aChange; // 降序
                }
            });
            
            // 排序后记录一些数据
            console.log('排序后的前5行数据:');
            for (var i = 0; i < Math.min(5, rows.length); i++) {
                var cell = rows[i].cells[3];
                var text = cell.textContent || '';
                console.log('行' + (i+1) + ': ' + text);
            }
            
            // 重新添加行
            Array.prototype.forEach.call(rows, function(row) {
                tbody.appendChild(row);
            });
            
            // 更新排序状态
            isChangeSortedDesc = !isChangeSortedDesc;
            console.log('更新排序状态为:', isChangeSortedDesc);
            
            // 更新表头样式
            header.classList.toggle('sorted', !isChangeSortedDesc);
        }
        
        // 题材筛选功能
        function filterByPlate(plateValue) {
            const tbody = document.getElementById('stockTableBody');
            // 使用更兼容的方式选择行
            const rows = Array.prototype.slice.call(tbody.getElementsByTagName('tr')).filter(function(row) {
                const cells = row.getElementsByTagName('td');
                return cells.length > 0 && cells[0].getAttribute('colspan') === null;
            });
            
            if (!plateValue) {
                // 如果没有输入筛选条件，显示所有行
                rows.forEach(row => {
                    row.style.display = '';
                });
                return;
            }
            
            // 发送AJAX请求到后端API进行筛选
            fetch(`/filter-by-plate?plate=${encodeURIComponent(plateValue)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(filteredStocks => {
                    // 显示匹配的行，隐藏不匹配的行
                    rows.forEach(row => {
                        // 正确选择股票代码列（第五列，索引4）
                        const codeElement = row.getElementsByTagName('td')[4];
                        if (codeElement) {
                            const code = codeElement.textContent.trim();
                            const isMatch = filteredStocks.some(stock => stock.code_part === code);
                            row.style.display = isMatch ? '' : 'none';
                        }
                    });
                })
                .catch(error => {
                    console.error('筛选题材失败:', error);
                });
        }

    </script>
</body>
</html>