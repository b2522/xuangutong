<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>热点题材解读</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
            font-size: 2.5em;
            font-weight: 600;
        }
        
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .search-container {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        
        .search-container input {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .search-container input:focus {
            outline: none;
            border-color: #2c3e50;
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1), 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        #dateFilter {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }
        
        #dateFilter:focus {
            outline: none;
            border-color: #2c3e50;
            box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1), 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 500px;
            overflow-y: auto;
            display: none;
            margin-top: 5px;
        }
        
        .search-suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 5px;
            margin: 2px 10px;
        }
        
        .search-suggestion-item:hover {
            background-color: #f0f4f8;
            transform: translateX(5px);
        }
        
        button {
            background-color: #0066CC;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            background-color: #004080;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            padding: 18px 15px;
            text-align: center;
            border-bottom: 3px solid #4285F4;
            background-color: #4285F4;
            color: white;
            font-weight: 600;
            font-size: inherit;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 15px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
            transition: all 0.2s ease;
        }
        
        tr {
            transition: all 0.3s ease;
        }
        
        tr:nth-child(even) {
            background-color: #fafbff;
        }
        
        tr:hover {
            background-color: #f0f4f8;
        }
        
        tr:hover td {
            background-color: transparent;
        }
        
        td:nth-child(1), td:nth-child(4), td:nth-child(5), td:nth-child(6), td:nth-child(8), td:nth-child(9) {
            text-align: center;
        }
        
        /* 调整列宽 */
        th:nth-child(1), td:nth-child(1) {
            width: 120px; /* 第一列：股票名称 */
        }
        
        th:nth-child(2), td:nth-child(2) {
            width: 80px; /* 第二列：价格 */
            text-align: right;
        }
        
        th:nth-child(3), td:nth-child(3) {
            width: 80px; /* 第三列：涨跌幅 */
            text-align: right;
        }
        
        /* 隐藏代码列和市场列 */
        th:nth-child(4), td:nth-child(4), /* 第四列：代码 */
        th:nth-child(5), td:nth-child(5)  /* 第五列：市场 */
        {
            display: none;
        }
        
        th:nth-child(6), td:nth-child(6) {
            width: 100px; /* 第六列：几天几板 */
        }
        
        th:nth-child(7), td:nth-child(7) {
            width: 500px; /* 第七列：解读 - 增加宽度以完整显示内容 */
        }
        
        th:nth-child(8), td:nth-child(8) {
            width: 100px; /* 第八列：所属题材 - 适当减少宽度 */
        }
        
        th:nth-child(9), td:nth-child(9) {
            width: 100px; /* 第九列：日期 - 适当减少宽度 */
        }
        
        /* 排序表头样式 */
        th.sortable {
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        /* 确保表头没有任何悬停效果 */
        th:hover {
            background-color: #4285F4;
            color: white;
        }
        
        th.sortable::after {
            content: '▼';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
        }
        
        th.sortable.sorted::after {
            color: white;
            transform: translateY(-50%) rotate(180deg);
        }
        
        /* 高级视觉效果 */
        .table-container {
            position: relative;
            overflow-x: auto;
        }
        
        .table-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            z-index: 1;
        }
        
        /* 3开头股票代码显示为橙色 */
        .orange-code {
            color: #FF7F00;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .no-data {
            text-align: center;
            padding: 80px;
            color: #777;
            font-size: 18px;
        }
        
        .date-info {
            background-color: #e8f4f8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }


        

        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                max-width: 100%;
            }
            
            h1 {
                font-size: 2em;
            }
        }
        

    </style>
</head>
<body>
    <div class="container">

        
        <div class="header-section">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="搜索股票名称..." oninput="showSuggestions(this.value)">
                <div id="searchSuggestions" class="search-suggestions"></div>
            </div>
            <button onclick="resetFilters()">复位</button>
            <form action="/crawl" method="post">
                <button type="submit">抓取股票数据</button>
            </form>
        </div>


        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>股票名称</th>
                        <th>价格</th>
                        <th class="sortable" onclick="sortByChangePercentage()">涨跌幅</th>
                        <th>代码</th>
                        <th>市场</th>
                        <th class="sortable" onclick="sortByDaysBoards()">几天几板</th>
                        <th>解读</th>
                        <th>
                            <input type="text" id="plateFilter" placeholder="输入题材或首字母" oninput="filterByPlate(this.value)" style="margin: 0 auto; display: block; padding: 5px; border: none; border-radius: 5px;">
                        </th>
                        <th>
                            <input type="date" id="dateFilter" placeholder="选择日期" onchange="filterByDate(this.value)" style="margin: 0 auto; display: block; padding: 5px; border: none; border-radius: 5px;">
                        </th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                    {% if stocks %}
                        {% for stock in stocks %}
                            <tr>
                                <td><a href="https://xuangutong.com.cn/stock/{{ stock.code_part }}.{{ stock.market|upper }}" target="_blank" style="text-decoration: none; color: #2c3e50;">{{ stock.name }}</a></td>
                                <td class="price"></td>
                                <td class="change-percentage"></td>
                                <td class="{% if stock.code_part.startswith('3') %}orange-code{% endif %}">{{ stock.code_part }}</td>
                                <td>{{ stock.market }}</td>
                                <td>{{ stock.m_days_n_boards }}</td>
                                <td>{{ stock.description }}</td>
                                <td>{{ stock.plates }}</td>
                                <td>{{ stock.date }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="no-data">暂无股票数据，请点击"抓取股票数据"按钮获取数据</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // 搜索建议功能，从后端API获取数据
        function showSuggestions(inputValue) {
            const suggestionsContainer = document.getElementById('searchSuggestions');
            
            if (inputValue === '') {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            // 发送AJAX请求到后端API
            fetch(`/search?keyword=${encodeURIComponent(inputValue)}`)
                .then(response => response.json())
                .then(filteredNames => {
                    console.log('后端返回的搜索结果数量:', filteredNames.length);
                    console.log('搜索结果:', filteredNames);
                    
                    if (filteredNames.length === 0) {
                        suggestionsContainer.style.display = 'none';
                        return;
                    }
                    
                    suggestionsContainer.innerHTML = '';
                    filteredNames.forEach(name => {
                        const div = document.createElement('div');
                        div.className = 'search-suggestion-item';
                        div.textContent = name;
                        div.onclick = () => {
                            document.getElementById('searchInput').value = name;
                            suggestionsContainer.style.display = 'none';
                            // 跳转到搜索结果页面
                            window.location.href = `/search-results?keyword=${encodeURIComponent(name)}`;
                        };
                        suggestionsContainer.appendChild(div);
                    });
                    
                    suggestionsContainer.style.display = 'block';
                })
                .catch(error => {
                    console.error('获取搜索建议失败:', error);
                    suggestionsContainer.style.display = 'none';
                });
        }
        
        // 日期过滤功能
        function filterByDate(dateValue) {
            if (!dateValue) {
                // 如果没有选择日期，重新加载页面显示最新数据
                window.location.href = '/';
                return;
            }
            
            // 统一日期格式：将YYYY-MM-DD转换为YYYYMMDD
            const normalizedDate = dateValue.replace(/-/g, '');
            
            // 发送AJAX请求获取指定日期的数据
            fetch(`/get-data-by-date?date=${encodeURIComponent(normalizedDate)}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('stockTableBody');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="no-data">该日期暂无数据</td></tr>';
                        return;
                    }
                    
                    // 渲染数据
                    data.forEach(stock => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><a href="https://xuangutong.com.cn/stock/${stock.code_part}.${stock.market.toUpperCase()}" target="_blank" style="text-decoration: none; color: #2c3e50;">${stock.name}</a></td>
                            <td class="price"></td>
                            <td class="change-percentage"></td>
                            <td class="${stock.code_part.startsWith('3') ? 'orange-code' : ''}">${stock.code_part}</td>
                            <td>${stock.market}</td>
                            <td>${stock.m_days_n_boards}</td>
                            <td>${stock.description}</td>
                            <td>${stock.plates}</td>
                            <td>${stock.date}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // 渲染完历史数据后，获取实时股票数据
                    fetchRealTimeStockData();
                })
                .catch(error => {
                    console.error('获取指定日期数据失败:', error);
                });
        }
        
        // 重置过滤条件
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('searchSuggestions').style.display = 'none';
            // 重新加载页面显示最新数据
            window.location.href = '/';
        }
        
        // 搜索输入框回车事件
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.trim();
                if (searchTerm) {
                    window.location.href = `/search-results?keyword=${encodeURIComponent(searchTerm)}`;
                }
            }
        });
        
        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchSuggestions').style.display = 'none';
            // 显示所有行
            const rows = document.querySelectorAll('#stockTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // 点击页面其他地方关闭搜索提示
        document.addEventListener('click', (e) => {
            const searchContainer = document.querySelector('.search-container');
            if (!searchContainer.contains(e.target)) {
                document.getElementById('searchSuggestions').style.display = 'none';
            }
        });
        


        // 加载可用日期并初始化日历选择器
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('dateFilter');
            if (dateInput) {
                // 设置最小和最大日期
                const minDate = '2025-12-01';
                const today = new Date().toISOString().split('T')[0];
                dateInput.min = minDate;
                dateInput.max = today;

                // 加载可用日期
                fetch('/available-dates')
                    .then(response => response.json())
                    .then(dates => {
                        // 存储可用日期
                        window.availableDates = dates;

                        // 验证选择的日期是否有数据且不是周末
                        dateInput.addEventListener('input', function(e) {
                            if (this.value) {
                                const selectedDate = this.value.replace(/-/g, '');
                                const dateObj = new Date(this.value);
                                const dayOfWeek = dateObj.getDay(); // 0=周日, 1=周一, ..., 6=周六
                                
                                // 检查是否是周末
                                if (dayOfWeek === 0 || dayOfWeek === 6) {
                                    alert('周六、周日不可选择');
                                    this.value = '';
                                    return;
                                }
                                
                                // 检查日期是否有数据
                                if (!window.availableDates.includes(selectedDate)) {
                                    alert('该日期无数据');
                                    this.value = '';
                                }
                            }
                        });
                    })
                    .catch(error => {
                        console.error('获取可用日期失败:', error);
                    });
            }
            
            // 获取实时股票数据
            fetchRealTimeStockData();
        });
        // 获取实时股票数据
        function fetchRealTimeStockData() {
            const tbody = document.getElementById('stockTableBody');
            const rows = tbody.querySelectorAll('tr:not(:has(td[colspan]))');
            
            if (rows.length === 0) {
                return;
            }
            
            // 收集所有股票代码并格式化
            const stockCodes = [];
            const codeMap = new Map(); // 用于存储股票代码和对应的行
            
            rows.forEach(row => {
                const codeElement = row.querySelector('td:nth-child(4)'); // 代码列现在是第4列
                if (codeElement) {
                    const code = codeElement.textContent.trim();
                    if (code) {
                        // 根据代码判断市场
                        let market = '';
                        if (code.startsWith('6')) {
                            market = 'SH';
                        } else if (code.startsWith('0') || code.startsWith('3')) {
                            market = 'SZ';
                        }
                        
                        if (market) {
                            const formattedCode = `${market}${code}`;
                            stockCodes.push(formattedCode);
                            codeMap.set(code, row);
                        }
                    }
                }
            });
            
            if (stockCodes.length === 0) {
                return;
            }
            
            // 构建API URL（使用后端代理）
            const apiUrl = `/api/realtime-stock-data?symbols=${stockCodes.join(',')}&_=${Date.now()}`;
            
            // 发送API请求获取实时数据
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    // 检查返回数据是否有效
                    if (data && data.data) {
                        // 遍历返回的股票数据
                        data.data.forEach(stock => {
                            const code = stock.symbol.substring(2); // 获取6位股票代码
                            const row = codeMap.get(code);
                            
                            if (row) {
                                // 确定颜色（红色上涨，绿色下跌，黑色不变）
                                const color = stock.percent > 0 ? '#e33232' : (stock.percent < 0 ? '#00a854' : '');
                                
                                // 更新价格
                                const priceElement = row.querySelector('.price');
                                if (priceElement) {
                                    priceElement.textContent = stock.current || '-';
                                    priceElement.style.color = color;
                                }
                                
                                // 更新涨跌幅
                                const changeElement = row.querySelector('.change-percentage');
                                if (changeElement) {
                                    changeElement.textContent = (stock.percent || 0).toFixed(2) + '%';
                                    changeElement.style.color = color;
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('获取实时股票数据失败:', error);
                });

        }
        
        // 第六列【几天几板】降序排列功能
        let isSortedDesc = false;
        let isChangeSortedDesc = false;
        
        function sortByDaysBoards() {
            const tbody = document.getElementById('stockTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(:has(td[colspan]))'));
            const header = document.querySelector('th.sortable');
            
            // 解析几天几板中的数字
            function getBoardCount(text) {
                if (!text) return 0;
                // 匹配天数和板数，例如 "3天3板" 会匹配到两个数字 [3, 3]
                const matches = text.match(/\d+/g);
                if (matches) {
                    // 优先使用板数（第二个数字），如果没有则使用天数（第一个数字）
                    return parseInt(matches[matches.length - 1]);
                }
                return 0;
            }
            
            // 排序
            rows.sort((a, b) => {
                const aCount = getBoardCount(a.cells[5].textContent);
                const bCount = getBoardCount(b.cells[5].textContent);
                
                if (isSortedDesc) {
                    return aCount - bCount; // 升序
                } else {
                    return bCount - aCount; // 降序
                }
            });
            
            // 重新添加行
            rows.forEach(row => tbody.appendChild(row));
            
            // 更新排序状态
            isSortedDesc = !isSortedDesc;
            
            // 更新表头样式
            header.classList.toggle('sorted', !isSortedDesc);
        }

        function sortByChangePercentage() {
            const tbody = document.getElementById('stockTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(:has(td[colspan]))'));
            const header = document.querySelector('th.sortable:nth-child(3)');
            
            // 解析涨跌幅百分比数值
            function getChangePercentage(text) {
                if (!text) return 0;
                // 移除%符号并转换为数字
                const matches = text.match(/[-+]?\d+(?:\.\d+)?/);
                if (matches) {
                    return parseFloat(matches[0]);
                }
                return 0;
            }
            
            // 排序
            rows.sort((a, b) => {
                const aChange = getChangePercentage(a.cells[2].textContent);
                const bChange = getChangePercentage(b.cells[2].textContent);
                
                if (isChangeSortedDesc) {
                    return aChange - bChange; // 升序
                } else {
                    return bChange - aChange; // 降序
                }
            });
            
            // 重新添加行
            rows.forEach(row => tbody.appendChild(row));
            
            // 更新排序状态
            isChangeSortedDesc = !isChangeSortedDesc;
            
            // 更新表头样式
            header.classList.toggle('sorted', !isChangeSortedDesc);
        }
        
        // 题材筛选功能
        function filterByPlate(plateValue) {
            const tbody = document.getElementById('stockTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(:has(td[colspan]))'));
            
            if (!plateValue) {
                // 如果没有输入筛选条件，显示所有行
                rows.forEach(row => {
                    row.style.display = '';
                });
                return;
            }
            
            // 发送AJAX请求到后端API进行筛选
            fetch(`/filter-by-plate?plate=${encodeURIComponent(plateValue)}`)
                .then(response => response.json())
                .then(filteredStocks => {
                    // 显示匹配的行，隐藏不匹配的行
                    rows.forEach(row => {
                        const codeElement = row.querySelector('td:nth-child(4)');
                        if (codeElement) {
                            const code = codeElement.textContent.trim();
                            const isMatch = filteredStocks.some(stock => stock.code_part === code);
                            row.style.display = isMatch ? '' : 'none';
                        }
                    });
                })
                .catch(error => {
                    console.error('筛选题材失败:', error);
                });
        }

    </script>
</body>
</html>